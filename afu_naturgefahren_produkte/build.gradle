import ch.so.agi.gretl.api.TransferSet
import ch.so.agi.gretl.tasks.*
import java.nio.file.Paths
import java.nio.file.Files
import groovy.json.JsonSlurper
import java.text.SimpleDateFormat
import java.util.Date
import java.util.ArrayList
import java.util.Iterator
import java.util.List


apply plugin: 'ch.so.agi.gretl'


defaultTasks 'synoptische_intensitaet_altdaten_copy'

//NUR PROVISORISCH! 
def Auftragskennung = 'Himmelried'

task truncateTables(type: SqlExecutor) {
    description = "Leert die Tabellen"
    database = [dbUriEdit, dbUserEdit, dbPwdEdit]
    sqlFiles = [
            'truncate_table.sql'
    ]
}

task createDatasetAndBaskets(type: SqlExecutor, dependsOn: truncateTables) {
    description = "Bacht die Baskets bereit"
    database = [dbUriEdit, dbUserEdit, dbPwdEdit]
    sqlFiles = ['createbaskets.sql']
    sqlParameters = [kennung: "'"+Auftragskennung+"'"]
}

task synoptische_intensitaet(type: Db2Db, dependsOn: createDatasetAndBaskets) {
    description = "Berechnugn der synoptischen Intensität mit den neuen Daten"
    sourceDb = [dbUriEdit, dbUserEdit, dbPwdEdit]
    targetDb = [dbUriEdit, dbUserEdit, dbPwdEdit]
    transferSets = [
            new TransferSet('synoptische_intensitaet.sql','afu_naturgefahren_staging_v1.synoptische_intensitaet', true)
    ];
    sqlParameters = [kennung: "'"+Auftragskennung+"'"]
}

task synoptische_intensitaet_altdaten_copy(type: Db2Db, dependsOn: synoptische_intensitaet) {
    description = "Kopieren der alten Daten der synoptischen Intensität"
    sourceDb = [dbUriEdit, dbUserEdit, dbPwdEdit]
    targetDb = [dbUriEdit, dbUserEdit, dbPwdEdit]
    transferSets = [
            new TransferSet('synoptische_intensitaet_altdaten_copy.sql','afu_naturgefahren_staging_v1.synoptische_intensitaet', false)
    ];
}