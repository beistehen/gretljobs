import ch.so.agi.gretl.tasks.*
import ch.so.agi.gretl.api.TransferSet
import de.undercouch.gradle.tasks.download.Download
import java.text.SimpleDateFormat
import java.util.zip.ZipInputStream
import java.util.zip.ZipEntry

apply plugin: 'ch.so.agi.gretl'
apply plugin: 'org.hidetake.ssh'

defaultTasks 'unpackFile'

def pathToTempFolder = System.getProperty("java.io.tmpdir")
ext.filename = 'bar'

// Credentials für den SFTP-Server
remotes {
    sftpServer {
        host = "ftp.interconnect.ch"
        user = "waldSO"
        password = "voVW2FRiSeGkBy"
    }
}

//Download-Task
task download () {
    description = "Download file from SFTP server"
    doLast {
        ssh.settings {
            knownHosts = allowAnyHosts
        }
        ssh.run {
            session(remotes.sftpServer) {
                get from: "test", into: pathToTempFolder
            }
        }
        println "File downloaded from SFTP server"
    }
}

// Über die ersten 10 Zeichen des Filenamens wird erruiert, welches das neuste File ist
// TODO: Abklären, ob das IMMER so ist! 
task show_latest_file (dependsOn:download){
    doLast {
        def latestFile = null
        def latestDate = null
        def files =  fileTree(pathToTempFolder).filter { it.isFile() }.files
        files.each { file ->
            def filename = file.name
            try {
                def dateFormat = new SimpleDateFormat("yyyy-MM-dd")
                def fileDate = dateFormat.parse(filename.substring(0,10))
                if (latestDate == null || fileDate.after(latestDate)) {
                    latestDate = fileDate
                    latestFile = filename
                }
            }
            catch (Exception e) {
                return; 
            }
        }
        println "Latest file: ${latestFile}"
        project.filename = latestFile
    }
}
  
task unpackFile(dependsOn: show_latest_file) {   
    doLast {
        ZipInputStream zis = new ZipInputStream(
            new FileInputStream(pathToTempFolder+"/"+project.filename)
        )
        ZipEntry entry = zis.getNextEntry()
        while (entry != null) {
            File file = new File(pathToTempFolder.toString(), entry.getName())
            if (entry.isDirectory()) {
                file.mkdirs()
            } else {
                FileOutputStream fos = new FileOutputStream(file)
                byte[] buffer = new byte[1024]
                int len
                while ((len = zis.read(buffer)) > 0) {
                    fos.write(buffer, 0, len)
                }
                fos.close()
            }
            entry = zis.getNextEntry()
            println file.name
        }
        zis.closeEntry()
        zis.close()
    }
}

task importWaldportal(type: Ili2pgReplace, dependsOn: unpackFile) {
    description = 'Import resp. ersetzt einmal in der Woche die GELAN-Daten (Topic: GELAN_Bodenbedeckung, Datentransfer) in der Erfassungsdatenbank'
    database = [dbUriEdit, dbUserEdit, dbPwdEdit]
    dbschema = "alw_landwirtschaft_tierhaltung_v1"
    models = 'SO_ALW_Landwirtschaft_Tierhaltung_20210426'
    dataFile = Paths.get(pathToTempFolder, 'Export_ais_ln.xtf')
    dataset = 'bodenbedeckung'
}